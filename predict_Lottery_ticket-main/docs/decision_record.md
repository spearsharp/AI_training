## 2025-10：KL8（快乐8）玩法迁移决策

### 背景
KL8（快乐8）相关源码、数据、分析与脚本已迁移至独立项目 [KL8-Lottery-Analyzer](https://github.com/KittenCN/kl8-lottery-analyzer)。迁移原因包括数据量大、分析逻辑独立、便于后续扩展。

### 决策
- 本仓库不再包含KL8相关功能，后续仅支持双色球、大乐透、排列三、七星彩、福彩3D等玩法。
- KL8相关API、数据处理、分析与文档全部移除。

### 影响
- 代码结构更清晰，便于维护和扩展。
- KL8用户需前往新仓库获取支持。

---

## 2024-06：红球预测唯一性修正决策

### 背景
原预测逻辑在极少数情况下可能出现红球重复，违背实际规则。

### 决策
- 修正 `src/pipeline.py` 预测逻辑，采用去重策略，确保每注红球号码唯一。
- 同步更新文档，明确修正内容。

### 影响
- 预测结果更贴合实际规则，用户体验提升。
- 相关API和文档均已同步。
# 架构决策记录（2024-XX 更新）

## 背景

早期版本依赖 TensorFlow 1.x 风格的 `Session/Graph` API，并通过手写循环驱动序列预测流程。随着 TensorFlow 2.x 的发布，旧实现出现以下问题：

- 新版本默认启用 Eager Execution，`tf.compat.v1` 图和 `Session` 已不再推荐，且与多项上游优化不兼容。
- 旧的 `.ckpt` 模型文件无法直接在最新 TensorFlow 中载入，且训练脚本缺乏超时与异常处理。
- `requests` 调用缺失超时和重试策略，不满足 AGENTS.md 关于外部依赖封装的要求。

在全面升级依赖的前提下，需要重新设计数据流程、模型封装与训练脚本。

## 决策

1. **运行时框架**：统一锁定 `tensorflow==2.15.1`，通过 `tf.keras` 提供的 API 构建与训练模型，确保在 Windows/Linux/macOS 均可安装。
2. **模型封装**：使用 Keras 函数式 API 实现多层 LSTM + Softmax 结构，同时复用窗口化输入与批量化训练逻辑，彻底移除对 `tensorflow-addons` 的依赖。
3. **数据与配置层**：拆分 `src/common.py`，新增 `src/data_fetcher.py`、`src/preprocessing.py`、`src/pipeline.py` 等模块，明确数据抓取、特征构造与训练流程的职责边界。
4. **模型持久化**：使用 `.keras`（SavedModel v3）格式保存模型与权重，配套 JSON 元数据描述窗口大小、类别数等参数，替换旧的 `.ckpt` 文件。
5. **网络访问**：构建带重试、超时、白名单域名校验的 `LotteryHttpClient`，满足外部调用安全规范。
6. **兼容策略**：不再兼容旧版 `.ckpt` 模型文件；若需要，可通过新脚本重新训练生成 `.keras` 模型。

## 影响

- **积极影响**
  - 拥抱 TensorFlow 2.x 的动态图与分布式优化能力，训练流程简化。
  - 模块边界清晰，可插拔地扩展数据获取或模型结构。
  - `.keras` 检查点跨平台加载无需手工定义图结构，预测脚本变得简单可靠。
  - Requests 封装具备超时/重试，符合安全要求并提高鲁棒性。

- **消极影响**
  - 旧版模型文件与脚本全部废弃，需要重新训练。
  - 由于训练过程改写，历史指标不可直接复现。
- `tensorflow==2.15.1` 官方提供 Windows/Linux/macOS 轮子，可在 Conda/venv 中直接安装。

## 替代方案

- 继续维持 `tf.compat.v1`：可以减少一次性重构成本，但在新版 TensorFlow 中长期维护成本高，且与 Keras 3 不兼容。
- 切换到 PyTorch：更贴合研究工作流，但迁移成本更大，现阶段优先保障现有业务可用性。
- 使用第三方 CRF 实现（如 sklearn-crfsuite）：能避免 TensorFlow 附带的复杂性，但与现有 LSTM 结构结合较困难，且在 Windows 下依旧存在编译成本。

综合考虑依赖升级范围与未来演进能力，选择现方案。

## 迁移步骤（摘要）

1. 更新 `requirements.txt`、`Makefile`，强制使用 `python311` Conda 环境与新依赖。
2. 重写 `src` 下模型与数据流程模块，提供面向对象的训练与预测接口。
3. 调整 CLI 脚本，使其通过 `src.pipeline` 调用新实现。
4. 重新编写测试与文档，验证依赖升级后的行为。

## 已知风险与缓解

- **tensorflow-wheel 可用性**：TensorFlow 2.15.1 官方提供 Windows/Linux/macOS 轮子，可在 Conda/venv 中直接安装。
- **LSTM 模型偏差**：纯 LSTM 相比 LSTM+CRF 在捕捉标签依赖上稍弱，可通过增加深度、加入注意力或后续混合模型补足。
- **数据源变更**：500.com 页面结构若调整会导致解析失败，数据客户端提供结构化异常与日志，后续可注入新解析器。

## 状态

本决策即时生效，并将随后续版本迭代在 `CHANGELOG.md` 中追踪。若上游依赖或业务需求发生重大变化，将重新评估。
