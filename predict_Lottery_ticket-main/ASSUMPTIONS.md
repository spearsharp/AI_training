6. KL8（快乐8）相关内容已于2025年10月迁移至独立项目 [KL8-Lottery-Analyzer](https://github.com/KittenCN/kl8-lottery-analyzer)。本仓库不再维护KL8相关功能。
   - 原因：KL8玩法数据量大、分析逻辑独立，单独维护便于扩展和优化。
   - 影响：本项目仅支持双色球、大乐透、排列三、七星彩、福彩3D等玩法。

7. 预测红球唯一性修正（2024-06）
   - 假设：每注红球号码应唯一，不能重复。
   - 措施：修正了 `src/pipeline.py` 预测逻辑，采用去重策略，彻底避免红球重复。
   - 影响：预测结果更贴合实际规则，提升用户体验。
# ASSUMPTIONS & DECISIONS

列出实现过程中所作的重要假设与决策，便于后续维护与审计。

1. 使用 `tf.keras`（随 TensorFlow 一起分发）而非第三方独立 `keras` 包。
   - 原因：独立 `keras` 版本与 TensorFlow 之间可能存在实现差异，曾导致 `keras.src.engine` 等导入错误。
   - 操作：在当前环境中卸载了独立的 `keras`（已在本仓库历史中记录）。

2. 二进制包（numpy、mkl、tensorflow-intel、torch 等）通过 conda 管理。
   - 原因：在 Windows 等平台上，许多科学/深度学习包需要编译好的二进制 wheel；conda 更适合管理这些二进制依赖，避免 pip 在本机编译时出现冲突。
   - 提供了 `environment.yml` 用于创建可重复的 conda 环境。

3. 为兼容第三方库在导入时检查已弃用的 TF API，添加了 `src/bootstrap.py` shim。
   - 目标：在程序最早期提供映射（例如将 `tf.ragged.RaggedTensorValue` 映射到 `tf.compat.v1.ragged.RaggedTensorValue`）以避免导入错误。
   - shim 是 best-effort 且局部抑制弃用警告，不应替代上游修复。

4. 锁定可移植 pip 依赖为 `requirements.lock.txt`（移除本地 file:/// 条目）。
   - 对于私有或 editable VCS 安装，保留在注释中，用户需自行配置访问权限。

5. 日志与弃用警告策略
   - shim 在内部临时抑制相关 DeprecationWarning，避免污染用户控制台输出。
# 项目假设与权衡 (Assumptions & Trade-offs)

本文件记录为了顺利升级到 TensorFlow 2.15.1 及其配套生态而确立的关键假设与权衡。若后续条件发生变化，请优先在此文档更新对应结论。

## 🎯 核心假设

### 0. 运行环境
- **假设**: 所有脚本与 CI 均在名为 `python311` 的 Conda 环境或等效的 Python 3.11 虚拟环境中执行。
- **权衡**: TensorFlow 2.15.1 对 Python 版本有明确要求，放弃旧版 Python 能减少兼容性问题。
- **替代方案**: 对于无法安装 Conda 的环境，可通过 Docker/WSL2 预装 python311。

### 1. 数据源
- **假设**: 500.com 提供的历史开奖数据在结构和内容上保持稳定、准确。
- **权衡**: 依赖单一数据源易受网络波动或页面结构调整影响。
- **缓解**: 通过自定义异常与日志提示快速定位故障，后续可扩展备用数据源。

### 2. 模型架构
- **假设**: 基于 TensorFlow 2.15.1 + Keras 2.15 的多层 LSTM 方案能够有效捕捉时间窗口内的号码分布关系。
- **权衡**: LSTM 对标签间依赖建模能力有限，可能不如 CRF 精细，但实现更简单、跨平台兼容性好。
- **替代方案**: Transformer、GRU、Temporal CNN 或在未来追加注意力模块。

### 3. 时间窗口
- **假设**: 最近 `windows_size` 期的彩票号码携带更有价值的统计信息。
- **权衡**: 单一固定窗口可能无法适配所有玩法；过大窗口将显著增加训练成本。
- **备选**: 文档中提供自定义窗口说明，后续可尝试注意力或加权策略。

### 4. 特征建模
- **假设**: 将彩票号码视作离散类别（而非连续数值）更符合序列建模语境。
- **权衡**: 无法直接建模号码之间的数值差异，需依靠模型学习潜在关系。
- **替代**: 增加差值、奇偶、冷热等派生特征，可在后续版本迭代。

## 🔧 技术选择权衡

### 1. 框架与依赖
- **选择**: `tensorflow==2.15.1`、`numpy>=1.24,<2.0`、`pandas>=2.2`。
- **原因**: 支持 Python 3.11，官方长期维护，并提供跨平台 wheel。
- **权衡**: GPU 版要求 CUDA ≥ 12.2；如需其它框架需重新实现训练流程。
- **替代**: 继续使用 `tf.compat.v1` 以保留旧代码，代价是未来维护成本持续增加。

### 2. 配置管理
- **选择**: `config/config.yaml` + `src/config.py` 数据类，配合 `.env` 提供敏感配置。
- **权衡**: 配置文件增多需要同步维护；但便于文档化和测试。
- **替代**: 单纯依赖环境变量或数据库配置中心。

### 3. 模型持久化
- **选择**: 统一使用 `.keras`（SavedModel v3）格式保存权重与计算图。
- **权衡**: 旧版 `.ckpt` 文件无法直接加载，需重新训练。
- **替代**: 提供双栈加载逻辑，但会引入大量 `tf.compat.v1` 代码与分支处理。

### 4. HTTP 客户端
- **选择**: 基于 `requests.Session` + `urllib3.Retry` 封装的 `LotteryHttpClient`，默认启用超时、重试与白名单校验。
- **权衡**: 增加实现复杂度；但满足安全要求并显著提升鲁棒性。
- **替代**: 直接使用裸 `requests.get`，风险较大。

## 📊 模型设计权衡

### 1. 批大小与梯度稳定性
- **假设**: 小批量（默认 `batch_size=32`）对 LSTM 收敛更友好。
- **措施**: 引入梯度裁剪与 `EarlyStopping`，并允许在配置中调整。

### 2. 损失函数
- **选择**: `SparseCategoricalCrossentropy`（逐位置分类）。
- **权衡**: 实现简单且跨平台兼容；若需捕捉标签依赖，可在后续引入注意力或条件解码。

### 3. 优化器
- **选择**: `tf.keras.optimizers.Adam(clipnorm=1.0)`。
- **权衡**: Adam 在中小数据集表现稳定；若需更快收敛可增加 `optimizer_type` 参数。

## 🏗️ 架构设计假设

### 1. 模块拆分
- **假设**: 数据抓取、特征工程、模型构建、训练与推理需要清晰分层。
- **实现**: 新增 `src/data_fetcher.py`、`src/preprocessing.py`、`src/modeling.py`、`src/pipeline.py`。
- **好处**: 提升复用性与可测试性。

### 2. 日志与错误处理
- **假设**: 统一通过 `loguru` 日志记录关键操作，并提供中文+英文关键词提示。
- **措施**: 所有外部操作均记录成功/失败状态与建议。

### 3. 配置可扩展性
- **假设**: 新玩法仅需在配置中补充元数据即可驱动训练/预测。
- **限制**: 若玩法结构差异过大，需要扩展预处理逻辑。

## 🚀 性能与资源假设

### 1. 计算资源
- **假设**: 单机（CPU 或单 GPU）即可完成训练；默认启用 GPU 内存自增长。
- **备选**: 未来可引入 `tf.distribute.MirroredStrategy` 做多 GPU 训练。

### 2. 内存
- **假设**: 历史开奖数据 < 200MB，可直接载入内存。
- **缓解**: 数据加载提供 `chunk_size` 参数，必要时可流式处理。

### 3. 训练时间
- **假设**: 在 GPU 上单模型训练 < 10 分钟；若无 GPU 约 30 分钟。
- **措施**: 文档提供多进程/多窗口并行训练指南。

## 🔒 安全与合规

### 1. 网络安全
- **假设**: 仅访问白名单域名 `datachart.500.com` 和 `data.917500.cn`。
- **措施**: 客户端在运行时校验请求域名，防止 SSRF。

### 2. 文件安全
- **假设**: 所有输出目录位于仓库根目录下的 `data/`、`model/`、`predict/`。
- **措施**: 覆盖写入前先备份旧文件；日志输出无敏感信息。

## 📈 扩展性与未来计划

1. 引入 Transformer/混合注意力模型，比较与当前多层 LSTM 的表现。
2. 支持多数据源聚合与质量评分。
3. 开放 RESTful API / gRPC 服务接口。
4. 构建自动超参搜索（Optuna/keras-tuner），提高迭代效率。
5. 记录推理元数据，便于可观测性与回溯分析。

---

**说明**：以上假设与策略与 2024 年 10 月的依赖与业务场景匹配。若依赖版本或部署目标发生改变，请同步更新本文档并在 `docs/decision_record.md` 中补充新的架构决策。***
